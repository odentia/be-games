name: Deploy to VPS

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build and Push Docker images to GHCR"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            mkdir -p ~/game-service
            cd ~/game-service
            
            cat > docker-compose.yml << EOF
            services:
              postgres:
                image: postgres:16-alpine
                container_name: game-service-postgres
                restart: unless-stopped
                environment:
                  POSTGRES_DB: ${{ secrets.POSTGRES_DB || 'games' }}
                  POSTGRES_USER: ${{ secrets.POSTGRES_USER || 'games_user' }}
                  POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
                volumes:
                  - postgres_data:/var/lib/postgresql/data
                networks:
                  - game-service-network
                healthcheck:
                  test: ["CMD-SHELL", "pg_isready -U ${{ secrets.POSTGRES_USER || 'games_user' }}"]
                  interval: 10s
                  timeout: 5s
                  retries: 5

              game-service:
                image: ghcr.io/${{ github.repository_owner }}/game-service:latest
                container_name: game-service
                restart: unless-stopped
                depends_on:
                  postgres:
                    condition: service_healthy
                ports:
                  - "8010:8010"
                environment:
                  - DATABASE_URL=${{ secrets.DATABASE_URL }}
                  - ALEMBIC_DATABASE_URL=${{ secrets.ALEMBIC_DATABASE_URL }}
                  - RAWG_API_KEY=${{ secrets.RAWG_API_KEY }}
                  - RAWG_BASE_URL=${{ secrets.RAWG_BASE_URL || 'https://api.rawg.io/api' }}
                  - RABBITMQ_URL=amqp://${{ secrets.RABBITMQ_USER || 'guest' }}:${{ secrets.RABBITMQ_PASSWORD || 'guest' }}@rabbitmq:5672/
                  - ENV=prod
                  - LOG_LEVEL=${{ secrets.LOG_LEVEL || 'INFO' }}
                networks:
                  - game-service-network
                  - infra_rabbitmq_network
                healthcheck:
                  test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8010/docs\")' || exit 1"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s

            networks:
              game-service-network:
                driver: bridge
              infra_rabbitmq_network:
                external: true

            volumes:
              postgres_data:
            EOF
            
            cat > .env << EOF
            POSTGRES_DB=${{ secrets.POSTGRES_DB || 'games' }}
            POSTGRES_USER=${{ secrets.POSTGRES_USER || 'games_user' }}
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            ALEMBIC_DATABASE_URL=${{ secrets.ALEMBIC_DATABASE_URL }}
            RAWG_API_KEY=${{ secrets.RAWG_API_KEY }}
            RAWG_BASE_URL=${{ secrets.RAWG_BASE_URL || 'https://api.rawg.io/api' }}
            RABBITMQ_USER=${{ secrets.RABBITMQ_USER || 'guest' }}
            RABBITMQ_PASSWORD=${{ secrets.RABBITMQ_PASSWORD || 'guest' }}
            LOG_LEVEL=${{ secrets.LOG_LEVEL || 'INFO' }}
            EOF
            
            if [ -n "${{ secrets.GHCR_TOKEN }}" ]; then
              echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            fi
            docker compose pull
            docker compose run --rm game-service uv run alembic upgrade head || echo "Migration failed or not needed"
            docker compose up -d
            docker image prune -f
